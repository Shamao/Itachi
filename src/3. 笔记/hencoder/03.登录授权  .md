登录授权、**TCP/IP**、**HTTPS** 

登录和授权的区别 

```
  登录:身份认证，即确认「你是你」的过程。
  授权:由身份或持有的令牌确认享有某些权限(例例如获取⽤用户信息)。登录过程实质上的⽬目的也
  是为了了确认权限。
因此，在实际的应⽤用中，多数场景下的「登录」和「授权」界限是模糊的。
```

**HTTP** 中确认授权(或登录)的两种⽅方式 1. 通过 Cookie 

\2. 通过 Authorization Header **Cookie** 

起源:「购物⻋车」功能的需求，由 Netscape 浏览器器开发团队打造。 ⼯工作机制: 

1. 服务器器需要客户端保存的内容，放在 Set-Cookie headers ⾥里里返回，客户端会⾃自动保存。 

2. 客户端保存的 Cookies，会在之后的所有请求⾥里里都携带进 Cookie header ⾥里里发回给服务 

   器器。 

3. 客户端保存 Cookie 是按照服务器器域名来分类的，例例如 shop.com 发回的 Cookie 保存下来 

   以后，在之后向 games.com 的请求中并不不会携带。 

4. 客户端保存的 Cookie 在超时后会被删除、没有设置超时时间的 Cookie (称作 Session Cookie)在浏览器器关闭后就会⾃自动删除;另外，服务器器也可以主动删除还未过期的客户端 Cookies。 

1 

扔物线学堂 rengwuxian.com 

Cookie 的作⽤用 会话管理理:登录状态、购物⻋车 

2 

扔物线学堂 rengwuxian.com 

个性化:⽤用户偏好、主题 

Tracking:分析⽤用户⾏行行为 

3 

扔物线学堂 rengwuxian.com 

XSS (Cross-site scripting)(了了解即可):跨站脚本攻击。即使⽤用 JavaScript 拿到浏览器器的 Cookie 之后，发送到⾃自⼰己的⽹网站，以这种⽅方式来盗取⽤用户 Cookie。应对⽅方式:Server 在发送 Cookie 时，敏敏感的 Cookie 加上 HttpOnly。 

应对⽅方式:HttpOnly——这个 Cookie 只能⽤用于 HTTP 请求，不不能被 JavaScript 调⽤用。它可 以防⽌止本地代码滥⽤用 Cookie。 

XSRF (Cross-site request forgery)(了了解即可):跨站请求伪造。即在⽤用户不不知情的情况下访问 已经保存了了 Cookie 的⽹网站，以此来越权操作⽤用户账户(例例如盗取⽤用户资⾦金金)。应对⽅方式主要是 从服务器器安全⻆角度考虑，就不不多说了了。 

应对⽅方式:Referer 校验。 

**Authorization** 

两种主流⽅方式: Basic 和 Bearer **Basic**: 

格式:Authorization: Basic <username:password(Base64ed)> **Bearer**: 

格式:Authorization: Bearer <bearer token>
 bearer token 的获取⽅方式:通过 OAuth2 的授权流程
 OAuth2 的流程(下⾯面的⽂文字可以配合视频课程或者 PPT 中的图来看): 

1. 第三⽅方⽹网站向授权⽅方⽹网站申请第三⽅方授权合作，拿到 client id 和 client secret 

2. ⽤用户在使⽤用第三⽅方⽹网站时，点击「通过 XX (如 GitHub) 授权」按钮，第三⽅方⽹网站将⻚页⾯面跳 

   转到授权⽅方⽹网站，并传⼊入 client id 作为⾃自⼰己的身份标识 

3. 授权⽅方⽹网站根据 client id ，将第三⽅方⽹网站的信息和第三⽅方⽹网站需要的⽤用户权限展示给⽤用 

   ```
        户，并询问⽤用户是否同意授权
   ```

4. ⽤用户点击「同意授权」按钮后，授权⽅方⽹网站将⻚页⾯面跳转回第三⽅方⽹网站，并传⼊入 

Authorization code 作为⽤用户认可的凭证。 

4 

扔物线学堂 rengwuxian.com 

1. 第三⽅方⽹网站将 Authorization code 发送回⾃自⼰己的服务器器 

2. 服务器器将 Authorization code 和⾃自⼰己的 client secret ⼀一并发送给授权⽅方的服务器器，授权⽅方 

   服务器器在验证通过后，返回 access token。OAuth 流程结束。 

3. 在上⾯面的过程结束之后，第三⽅方⽹网站的服务器器(或者有时客户端也会)就可以使⽤用 access 

   token 作为⽤用户授权的令牌，向授权⽅方⽹网站发送请求来获取⽤用户信息或操作⽤用户账户。但这 

   已经在 OAuth 流程之外。 

为什什么 OAuth 要引⼊入 Authorization code，并需要申请授权的第三⽅方将 Authorization code 发 送回⾃自⼰己的服务器器，再从服务器器来获取 access token，⽽而不不是直接返回 access token ?这样复 杂的流程意义何在? 为了了安全。OAuth 不不强制授权流程必须使⽤用 HTTPS，因此需要保证当通信 路路径中存在窃听者时，依然具有⾜足够⾼高的安全性。 

第三⽅方 App 通过微信登录的流程，也是⼀一个 OAuth2 流程: 

1. 第三⽅方 App 向腾讯申请第三⽅方授权合作，拿到 client id 和 client secret 

2. ⽤用户在使⽤用第三⽅方 App 时，点击「通过微信登录」，第三⽅方 App 将使⽤用微信 SDK 跳转到 

   微信，并传⼊入⾃自⼰己的 client id 作为⾃自⼰己的身份标识 

3. 微信通过和服务器器交互，拿到第三⽅方 App 的信息，并限制在界⾯面中，然后询问⽤用户是否同 

   意授权该 App 使⽤用微信来登录 

4. ⽤用户点击「使⽤用微信登录」后，微信和服务器器交互将授权信息提交，然后跳转回第三⽅方 

   App，并传⼊入 Authorization code 作为⽤用户认可的凭证 

5. 第三⽅方 App 调⽤用⾃自⼰己服务器器的「微信登录」Api，并传⼊入 Authorization code，然后等待 

   服务器器的响应 

6. 服务器器在收到登录请求后，拿收到的 Authorization code 去向微信的第三⽅方授权接⼝口发送 

   请求，将 Authorization code 和⾃自⼰己的 client secret ⼀一起作为参数发送，微信在验证通过 

   后，返回 access token 

7. 服务器器在收到 access token 后，⽴立即拿着 access token 去向微信的⽤用户信息接⼝口发送请 

   ```
       求，微信验证通过后，返回⽤用户信息
   ```

8. 服务器器在收到⽤用户信息后，在⾃自⼰己的数据库中为⽤用户创建⼀一个账户，并使⽤用从微信服务器器 

   拿来的⽤用户信息填⼊入⾃自⼰己的数据库，以及将⽤用户的 ID 和⽤用户的微信 ID 做关联 

9. ⽤用户创建完成后，服务器器向客户端的请求发送响应，传送回刚创建好的⽤用户信息 

10. 客户端收到服务器器响应，⽤用户登录成功 

在⾃自家 App 中使⽤用 Bearer token 

有的 App 会在 Api 的设计中，将登录和授权设计成类似 OAuth2 的过程，但简化掉 Authorization code 概念。即:登录接⼝口请求成功时，会返回 access token，然后客户端在之 后的请求中，就可以使⽤用这个 access token 来当做 bearer token 进⾏行行⽤用户操作了了。 

Refresh token 

```
{
    "token_type": "Bearer",
    "access_token": "xxxxx",
    "refresh_token": "xxxxx",
    "expires_time": "xxxxx"
```

} 

⽤用法:access token 有失效时间，在它失效后，调⽤用 refresh token 接⼝口，传⼊入 refresh_token 来获取新的 access token。 

5 

扔物线学堂 rengwuxian.com 

⽬目的:安全。当 access token 失窃，由于它有失效时间，因此坏⼈人只有较短的时间来「做坏 事」;同时，由于(在标准的 OAuth2 流程中)refresh token 永远只存在与第三⽅方服务的服务 器器中，因此 refresh token ⼏几乎没有失窃的⻛风险。 

**TCP / IP** 协议族 

概念 

```
⼀一系列列协议所组成的⼀一个⽹网络分层模型
```

为什什么要分层? 

因为⽹网络的不不稳定性 

具体分层: 

Application Layer 应⽤用层:HTTP、FTP、DNS Transport Layer 传输层:TCP、UDP
 Internet Layer ⽹网络层:IP
 Link Layer 数据链路路层:以太⽹网、Wi-Fi 

**TCP** 连接
 什什么叫做连接 通信双⽅方建⽴立确认「可以通信」，不不会将对⽅方的消息丢弃，即为「建⽴立连接」 **TCP** 连接的建⽴立与关闭 

6 

扔物线学堂 rengwuxian.com 

7 

扔物线学堂 rengwuxian.com 

⻓长连接 为什什么要⻓长连接? 

因为移动⽹网络并不不在 Internet 中，⽽而是在运营商的内⽹网，并不不具有真正的公⽹网 IP，因此当某个 TCP 连接在⼀一段时间不不通信之后，⽹网关会出于⽹网络性能考虑⽽而关闭这条 TCP 连接和公⽹网的连接通道，导致 这个 TCP 端⼝口不不再能收到外部通信消息，即 TCP 连接被动关闭。 

⻓长连接的实现⽅方式 

⼼心跳。即在⼀一定间隔时间内，使⽤用 TCP 连接发送超短⽆无意义消息来让⽹网关不不能将⾃自⼰己定义为「空闲连 接」，从⽽而防⽌止⽹网关将⾃自⼰己的连接关闭。 

**HTTPS** 

定义 

8 

扔物线学堂 rengwuxian.com 

HTTP over SSL 的简称，即⼯工作在 SSL (或 TLS)上的 HTTP。说⽩白了了就是加密通信的 HTTP。 

⼯工作原理理 

```
在客户端和服务器器之间协商出⼀一套对称密钥，每次发送信息之前将内容加密，收到之后解密，达到内
容的加密传输
为什什么不不直接⽤用⾮非对称加密?
⾮非对称加密由于使⽤用了了复杂了了数学原理理，因此计算相当复杂，如果完全使⽤用⾮非对称加密来加密通信内
容，会严重影响⽹网络通信的性能
```

**HTTPS** 连接建⽴立的过程 

1. Client Hello

2. Server Hello

3. 服务器器证书 信任建⽴立

4. Pre-master Secret

5. 客户端通知:将使⽤用加密通信
6. 客户端发送:Finished

7. 服务器器通知:将使⽤用加密通信
8. 服务器器发送:Finished

在 **Android** 中使⽤用 **HTTPS** 正常情况
 直接使⽤用 需要⾃自⼰己写证书验证过程的场景 

⽤用的是⾃自签名证书(例例如只⽤用于内⽹网的 https) 证书信息不不全，缺乏中间证书机构(可能性不不⼤大) ⼿手机操作系统较旧，没有安装最新加⼊入的根证书 